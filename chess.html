<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chess Master P2P</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --sq: calc(min(98vw, 450px) / 8); --light: #ebecd0; --dark: #779556; }
        body { background: #121212; color: white; font-family: system-ui; margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; }
        #board-container { margin-top: 20px; border: 4px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #board { display: grid; grid-template-columns: repeat(8, var(--sq)); grid-template-rows: repeat(8, var(--sq)); }
        .sq { width: var(--sq); height: var(--sq); display: flex; justify-content: center; align-items: center; font-size: calc(var(--sq) * 0.7); cursor: pointer; position: relative; }
        .l { background: var(--light); } .d { background: var(--dark); }
        .sel { background: #f6f669 !important; }
        .dot::after { content: ''; width: 25%; height: 25%; background: rgba(0,0,0,0.15); border-radius: 50%; position: absolute; }
        #setup { position: fixed; inset: 0; background: #000; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #ui { width: 100%; max-width: 450px; padding: 15px; display: flex; justify-content: space-between; font-weight: bold; }
        .btn { background: #779556; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        input { padding: 12px; border-radius: 8px; border: 1px solid #444; background: #222; color: #fff; text-align: center; margin-bottom: 10px; width: 200px; }
    </style>
</head>
<body>
    <div id="setup">
        <h1 style="color:#779556">CHESS PRO</h1>
        <div id="my-id" style="font-size: 2.5rem; margin: 15px;">...</div>
        <input type="number" id="join-id" placeholder="Partner ID">
        <button class="btn" onclick="connect()">CONNECT & PLAY</button>
    </div>
    <div id="ui"><div id="status">WAITING...</div><div id="color-tag">WHITE</div></div>
    <div id="board-container"><div id="board"></div></div>

<script>
    const boardEl = document.getElementById('board');
    let b = [], sel = null, turn = false, myCol = 'w', conn = null, validMoves = [];
    const icons = {'r':'♜','n':'♞','b':'♝','q':'♛','k':'♚','p':'♟','R':'♖','N':'♘','B':'♗','Q':'♕','K':'♔','P':'♙'};
    const init = [['r','n','b','q','k','b','n','r'],['p','p','p','p','p','p','p','p'],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],['P','P','P','P','P','P','P','P'],['R','N','B','Q','K','B','N','R']];

    const peer = new Peer(Math.floor(1000 + Math.random()*9000).toString());
    peer.on('open', id => document.getElementById('my-id').innerText = id);
    peer.on('connection', c => { conn = c; myCol = 'w'; turn = true; setupConn(); start(); });

    function connect() { const tid = document.getElementById('join-id').value; conn = peer.connect(tid); myCol = 'b'; turn = false; setupConn(); start(); }
    function setupConn() { conn.on('data', d => { if(d.t==='M') { b = d.b; turn = true; render(); } }); }
    function start() { document.getElementById('setup').style.display='none'; b = JSON.parse(JSON.stringify(init)); document.getElementById('color-tag').innerText = myCol==='w'?'WHITE':'BLACK'; render(); }

    function getValidMoves(r, c) {
        let moves = []; const p = b[r][c].toLowerCase(); const isWhite = b[r][c] === b[r][c].toUpperCase();
        const dirs = {'r':[[0,1],[0,-1],[1,0],[-1,0]], 'b':[[1,1],[1,-1],[-1,1],[-1,-1]], 'q':[[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]], 'n':[[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]], 'k':[[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]]};
        if(p==='p') {
            let d = isWhite?-1:1;
            if(!b[r+d][c]) moves.push({r:r+d, c:c});
            if(c>0 && b[r+d][c-1] && isOpponent(b[r+d][c-1])) moves.push({r:r+d, c:c-1});
            if(c<7 && b[r+d][c+1] && isOpponent(b[r+d][c+1])) moves.push({r:r+d, c:c+1});
        } else if(dirs[p]) {
            dirs[p].forEach(dir => {
                let nr=r+dir[0], nc=c+dir[1];
                while(nr>=0 && nr<8 && nc>=0 && nc<8) {
                    if(!b[nr][nc]) { moves.push({r:nr, c:nc}); if(p==='n'||p==='k') break; }
                    else { if(isOpponent(b[nr][nc])) moves.push({r:nr, c:nc}); break; }
                    nr+=dir[0]; nc+=dir[1];
                }
            });
        }
        return moves;
    }

    function isOpponent(p) { if(!p) return false; return myCol==='w' ? p===p.toLowerCase() : p===p.toUpperCase(); }

    function render() {
        boardEl.innerHTML = ''; document.getElementById('status').innerText = turn ? "YOUR MOVE" : "OPPONENT'S TURN";
        for(let r=0; r<8; r++) for(let c=0; c<8; c++) {
            const sq = document.createElement('div'); sq.className = `sq ${(r+c)%2===0?'l':'d'} ${sel?.r===r && sel?.c===c?'sel':''} ${validMoves.some(m=>m.r===r && m.c===c)?'dot':''}`;
            sq.innerText = icons[b[r][c]] || '';
            sq.onclick = () => {
                if(!turn) return;
                if(sel && validMoves.some(m=>m.r===r && m.c===c)) {
                    let p = b[sel.r][sel.c]; if(p.toLowerCase()==='p' && (r===0||r===7)) p = myCol==='w'?'Q':'q';
                    b[r][c] = p; b[sel.r][sel.c] = 0; turn = false; sel = null; validMoves = [];
                    if(conn) conn.send({t:'M', b}); render();
                } else if(b[r][c] && !isOpponent(b[r][c])) {
                    sel = {r,c}; validMoves = getValidMoves(r,c); render();
                } else { sel = null; validMoves = []; render(); }
            };
            boardEl.appendChild(sq);
        }
    }
</script>
</body>
</html>