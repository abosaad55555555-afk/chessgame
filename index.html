<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚ôú Fixed Movement Chess</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; font-family: sans-serif; }
        body { background-color: #1a2e3f; color: white; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 10px; }
        .game-container { width: min(95vw, 500px); background: #2c3e50; border-radius: 20px; padding: 15px; box-shadow: 0 15px 40px rgba(0,0,0,0.6); }
        .status-bar { background: #1e2b38; padding: 12px; border-radius: 12px; text-align: center; font-weight: 800; margin-bottom: 10px; border: 1px solid #4a5f72; }
        .board { display: grid; grid-template-columns: repeat(8, 1fr); aspect-ratio: 1/1; border: 4px solid #34495e; background: #34495e; gap: 0; }
        .square { display: flex; justify-content: center; align-items: center; font-size: min(10vw, 45px); cursor: pointer; background-color: #f0d9b5; line-height: 0; position: relative; }
        .square.dark { background-color: #b58863; }
        .square.selected { background-color: #fff2b5 !important; }
        .capture-zone { display: flex; justify-content: space-between; padding: 5px 10px; min-height: 40px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 8px; align-items: center; font-size: 1.2rem; }
        #copyLink { margin-top: 15px; font-size: 0.75rem; color: #e67e22; font-weight: bold; cursor: pointer; text-align: center; display: block; }
    </style>
</head>
<body>

<div class="game-container">
    <div id="status" class="status-bar">CONNECTING...</div>
    <div class="capture-zone"><div id="white-caps"></div><div id="black-caps"></div></div>
    <div class="board" id="board"></div>
    <div id="copyLink"></div>
</div>

<script>
(function() {
    const symbols = {'r':'‚ôú','n':'‚ôû','b':'‚ôù','q':'‚ôõ','k':'‚ôö','p':'‚ôü','R':'‚ôú','N':'‚ôû','B':'‚ôù','Q':'‚ôõ','K':'‚ôö','P':'‚ôô'};
    let board = [], currentPlayer = 'w', myColor = null, selected = null, peer, conn;

    function initBoard() {
        board = [
            ['r','n','b','q','k','b','n','r'],['p','p','p','p','p','p','p','p'],
            ['','','','','','','',''],['','','','','','','',''],
            ['','','','','','','',''],['','','','','','','',''],
            ['P','P','P','P','P','P','P','P'],['R','N','B','Q','K','B','N','R']
        ];
    }

    // --- MOVEMENT VALIDATION ---
    function canMove(fr, fc, tr, tc) {
        const p = board[fr][fc];
        const target = board[tr][tc];
        if (!p) return false;
        const color = p === p.toUpperCase() ? 'w' : 'b';
        if (color !== currentPlayer) return false;
        if (target && (target === target.toUpperCase() ? 'w' : 'b') === color) return false;
        
        const dr = Math.abs(tr - fr);
        const dc = Math.abs(tc - fc);
        const type = p.toLowerCase();

        if (type === 'p') {
            const dir = color === 'w' ? -1 : 1;
            if (fc === tc && !target) {
                if (tr === fr + dir) return true;
                if (tr === fr + 2*dir && (fr === 1 || fr === 6) && !board[fr+dir][fc]) return true;
            }
            if (dr === 1 && dc === 1 && target) return true;
            return false;
        }
        if (type === 'n') return (dr === 2 && dc === 1) || (dr === 1 && dc === 2);
        if (type === 'k') return dr <= 1 && dc <= 1;
        
        // Sliding pieces (Rook, Bishop, Queen)
        if (type === 'r' || type === 'q' || type === 'b') {
            if (type === 'r' && fr !== tr && fc !== tc) return false;
            if (type === 'b' && dr !== dc) return false;
            if (type === 'q' && dr !== dc && fr !== tr && fc !== tc) return false;
            
            const stepR = tr === fr ? 0 : (tr > fr ? 1 : -1);
            const stepC = tc === fc ? 0 : (tc > fc ? 1 : -1);
            let r = fr + stepR, c = fc + stepC;
            while (r !== tr || c !== tc) {
                if (board[r][c]) return false;
                r += stepR; c += stepC;
            }
            return true;
        }
        return false;
    }

    function executeMove(fr, fc, tr, tc) {
        board[tr][tc] = board[fr][fc];
        board[fr][fc] = '';
        currentPlayer = (currentPlayer === 'w') ? 'b' : 'w';
        render();
    }

    function initNetwork() {
        const room = new URLSearchParams(window.location.search).get('room');
        peer = new Peer();
        peer.on('open', id => {
            if (!room) {
                myColor = 'w';
                const link = window.location.origin + window.location.pathname + '?room=' + id;
                document.getElementById('copyLink').innerText = "üîó COPY INVITE LINK";
                document.getElementById('copyLink').onclick = () => { navigator.clipboard.writeText(link); alert("Link copied!"); };
            } else {
                myColor = 'b';
                conn = peer.connect(room);
                conn.on('open', () => render());
                conn.on('data', data => { if(data.type==='move') executeMove(data.fr, data.fc, data.tr, data.tc); });
            }
        });
        peer.on('connection', c => { 
            conn = c; 
            conn.on('open', () => render()); 
            conn.on('data', data => { if(data.type==='move') executeMove(data.fr, data.fc, data.tr, data.tc); });
        });
    }

    function render() {
        const bEl = document.getElementById('board');
        bEl.innerHTML = '';
        document.getElementById('status').innerText = `${currentPlayer==='w'?'White':'Black'} Turn ${currentPlayer===myColor?'(YOU)':''}`;

        const rows = myColor === 'b' ? [0,1,2,3,4,5,6,7] : [7,6,5,4,3,2,1,0];
        for (let r of rows) {
            for (let c = 0; c < 8; c++) {
                const s = document.createElement('div');
                s.className = `square ${(r+c)%2===0?'dark':'light'}`;
                if (selected && selected.r === r && selected.c === c) s.classList.add('selected');
                
                const p = board[r][c];
                if (p) {
                    s.innerText = symbols[p];
                    s.style.color = p === p.toUpperCase() ? "white" : "black";
                    if(p === p.toUpperCase()) s.style.textShadow = "1px 1px 2px black";
                }
                
                s.onclick = () => {
                    if (currentPlayer !== myColor) return;
                    if (!selected) {
                        if (p && (p === p.toUpperCase() ? 'w' : 'b') === myColor) {
                            selected = {r, c};
                            render();
                        }
                    } else {
                        if (canMove(selected.r, selected.c, r, c)) {
                            conn.send({type: 'move', fr: selected.r, fc: selected.c, tr: r, tc: c});
                            executeMove(selected.r, selected.c, r, c);
                        }
                        selected = null;
                        render();
                    }
                };
                bEl.appendChild(s);
            }
        }
    }

    initBoard();
    initNetwork();
    render();
})();
</script>
</body>
</html>