<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>â™œ Pro P2P Chess</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background-color: #1a2e3f; color: white; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 10px; }
        
        .game-container { width: min(95vw, 500px); background: #2c3e50; border-radius: 20px; padding: 15px; box-shadow: 0 15px 40px rgba(0,0,0,0.6); }
        
        .status-bar { background: #1e2b38; padding: 12px; border-radius: 12px; text-align: center; font-weight: 800; margin-bottom: 10px; border: 1px solid #4a5f72; color: #ecf0f1; letter-spacing: 1px; }
        
        .board { display: grid; grid-template-columns: repeat(8, 1fr); aspect-ratio: 1/1; border: 4px solid #34495e; border-radius: 4px; overflow: hidden; background: #34495e; gap: 0; }
        
        /* Fixed piece alignment */
        .square { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: min(10vw, 45px); 
            cursor: pointer; 
            background-color: #f0d9b5; 
            position: relative;
            line-height: 0; /* Critical for centering symbols */
        }
        .square.dark { background-color: #b58863; }
        .square.selected { background-color: #fff2b5 !important; box-shadow: inset 0 0 15px rgba(0,0,0,0.2); }
        
        /* Capture Styling */
        .capture-zone { display: flex; justify-content: space-between; padding: 5px 10px; min-height: 40px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 8px; align-items: center; }
        .caps { font-size: 1.2rem; letter-spacing: -3px; filter: drop-shadow(1px 1px 0px rgba(0,0,0,0.3)); }

        /* Chat & Buttons */
        .chat-area { margin-top: 15px; background: #1e2b38; border-radius: 12px; padding: 10px; border: 1px solid #4a5f72; }
        #messages { height: 70px; overflow-y: auto; font-size: 0.85rem; color: #bdc3c7; margin-bottom: 8px; padding-right: 5px; }
        #chat-input { width: 100%; padding: 10px; border-radius: 8px; border: none; background: #2c3e50; color: white; outline: none; border: 1px solid #34495e; }

        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        button { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; background: #e67e22; color: white; transition: 0.1s; }
        button:active { transform: scale(0.98); opacity: 0.9; }

        #copyLink { margin-top: 15px; font-size: 0.75rem; color: #e67e22; font-weight: bold; cursor: pointer; text-align: center; background: rgba(230, 126, 34, 0.1); padding: 5px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="game-container">
    <div id="status" class="status-bar">INITIALIZING...</div>
    
    <div class="capture-zone">
        <div id="white-caps" class="caps"></div>
        <div id="black-caps" class="caps"></div>
    </div>

    <div class="board" id="board"></div>

    <div class="btn-group">
        <button id="reset-btn">REQUEST NEW GAME</button>
    </div>

    <div class="chat-area">
        <div id="messages">System: Connect a friend to play...</div>
        <input type="text" id="chat-input" placeholder="Say hello...">
    </div>

    <div id="copyLink"></div>
</div>

<script>
(function() {
    // Solid symbols work best for forced coloring
    const symbols = {
        'r':'â™œ','n':'â™ž','b':'â™','q':'â™›','k':'â™š','p':'â™Ÿ',
        'R':'â™œ','N':'â™ž','B':'â™','Q':'â™›','K':'â™š','P':'â™Ÿ'
    };
    
    let board = [], currentPlayer = 'w', myColor = null, selected = null, peer, conn;
    let caps = { w: [], b: [] };

    function initBoard() {
        board = [
            ['r','n','b','q','k','b','n','r'],['p','p','p','p','p','p','p','p'],
            ['','','','','','','',''],['','','','','','','',''],
            ['','','','','','','',''],['','','','','','','',''],
            ['P','P','P','P','P','P','P','P'],['R','N','B','Q','K','B','N','R']
        ];
        caps = { w: [], b: [] };
        currentPlayer = 'w';
        selected = null;
    }

    function initNetwork() {
        const room = new URLSearchParams(window.location.search).get('room');
        peer = new Peer();

        peer.on('open', id => {
            if (!room) {
                myColor = 'w';
                const link = window.location.origin + window.location.pathname + '?room=' + id;
                document.getElementById('copyLink').innerText = "ðŸ”— CLICK TO COPY INVITE LINK";
                document.getElementById('copyLink').onclick = () => {
                    navigator.clipboard.writeText(link);
                    addMsg("System: Link copied! Send it to your friend.");
                };
                updateStatus("WAITING FOR OPPONENT...");
            } else {
                myColor = 'b';
                conn = peer.connect(room);
                bindEvents();
                updateStatus("CONNECTING...");
            }
        });

        peer.on('connection', c => {
            conn = c;
            bindEvents();
        });
    }

    function bindEvents() {
        conn.on('open', () => {
            addMsg("System: Opponent Connected. Good luck!");
            render();
        });
        conn.on('data', data => {
            if (data.type === 'move') executeMove(data.fr, data.fc, data.tr, data.tc);
            if (data.type === 'chat') addMsg("Opponent: " + data.msg);
            if (data.type === 'reset') if(confirm("Opponent requested a new game. Reset?")) { initBoard(); render(); }
        });
    }

    function executeMove(fr, fc, tr, tc) {
        const target = board[tr][tc];
        if (target) {
            const side = target === target.toUpperCase() ? 'b' : 'w';
            caps[side].push(symbols[target]);
        }
        board[tr][tc] = board[fr][fc];
        board[fr][fc] = '';
        
        if (board[tr][tc].toLowerCase() === 'p' && (tr === 0 || tr === 7)) {
            board[tr][tc] = (board[tr][tc] === 'p') ? 'q' : 'Q';
        }

        currentPlayer = (currentPlayer === 'w') ? 'b' : 'w';
        render();
    }

    function updateStatus(msg) { document.getElementById('status').innerText = msg; }

    function addMsg(txt) {
        const m = document.getElementById('messages');
        m.innerHTML += `<div>${txt}</div>`;
        m.scrollTop = m.scrollHeight;
    }

    function render() {
        const bEl = document.getElementById('board');
        bEl.innerHTML = '';
        const isMyTurn = (currentPlayer === myColor);
        updateStatus(`${currentPlayer === 'w' ? 'WHITE' : 'BLACK'} TURN ${isMyTurn ? '(YOU)' : ''}`);
        
        document.getElementById('white-caps').innerText = caps.w.join('');
        document.getElementById('black-caps').innerText = caps.b.join('');

        // Perspectives
        const rowOrder = myColor === 'w' ? [0,1,2,3,4,5,6,7].reverse() : [0,1,2,3,4,5,6,7];
        const colOrder = myColor === 'w' ? [0,1,2,3,4,5,6,7] : [0,1,2,3,4,5,6,7].reverse();

        for (let r of rowOrder) {
            for (let c of colOrder) {
                const s = document.createElement('div');
                s.className = `square ${(r + c) % 2 === 0 ? 'dark' : 'light'}`;
                if (selected && selected.r === r && selected.c === c) s.classList.add('selected');
                
                const piece = board[r][c];
                if (piece) {
                    s.innerText = symbols[piece];
                    const isWhite = piece === piece.toUpperCase();
                    s.style.color = isWhite ? "#FFFFFF" : "#000000";
                    // Add contrast shadow to white pieces
                    if (isWhite) s.style.textShadow = "1px 1px 3px rgba(0,0,0,0.4)";
                }
                
                s.onclick = () => {
                    if (!isMyTurn || !conn || !conn.open) return;
                    if (!selected) {
                        if (piece && (piece === piece.toUpperCase() ? 'w' : 'b') === myColor) selected = {r, c};
                    } else {
                        if (r !== selected.r || c !== selected.c) {
                            conn.send({type: 'move', fr: selected.r, fc: selected.c, tr: r, tc: c});
                            executeMove(selected.r, selected.c, r, c);
                        }
                        selected = null;
                    }
                    render();
                };
                bEl.appendChild(s);
            }
        }
    }

    document.getElementById('chat-input').onkeypress = e => {
        if (e.key === 'Enter' && conn && e.target.value.trim()) {
            conn.send({type: 'chat', msg: e.target.value});
            addMsg("You: " + e.target.value);
            e.target.value = '';
        }
    };

    document.getElementById('reset-btn').onclick = () => { 
        if(conn) {
            conn.send({type:'reset'});
            addMsg("System: Reset request sent...");
        } 
    };

    initBoard();
    initNetwork();
    render();
})();
</script>
</body>
</html>